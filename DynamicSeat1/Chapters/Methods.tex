% !TEX root = sum1.tex

\section{Dynamic Seat Assignment(DSA)}
This section discusses policies for assigning seats under conditions of stochastic information. We first present the dynamic seat assignment policy for each group arrival, which incorporates group-type control and loss control to optimize resource utilization. We also compare this approach with the bid-price policy. Next, we discuss the dynamic seat assignment policy for all group arrivals together. Finally, we establish the FCFS policy as the benchmark.



We can estimate the arrival rate from the historical data, $p_i = \frac{N_{i}}{N_{0}}, i \in \mathcal{M}$, where $N_{0}$ is the number of total groups, $N_{i}$ is the number of group type $i$. Suppose there are $T$ independent periods, one group will arrive in each period. There are still $M$ different group types. Let $\mathbf{y}$ be a discrete random variable indicating the number of people in the group. Let $\mathbf{p}$ be the vector probability, where $p(y = i) = p_i$, $i \in \mathcal{M}$ and $\sum_{i} p_{i} =1$.


% \subsection{Generate scenarios by discrete periods}\label{MappingSeq}
% In the dynamic situation, we can use stochastic information to generate the sequences of group arrivals. The sequences can be integrated to obtain the scenario of demands.


% Example:
% The group types are $[2,3,4,5]$. The number of periods is $20$. The number of given rows is 4 and the number of seats is 22.
% Each group arrives with the same probability.
% The number of sequences generating from multinomial distribution is $1000$. Then, we can obtain $[0,3,6,11]$ from stochastic programming. When the number of sequences is 5000, we still obtain $[0,3,6,11]$. It shows that sampling is practical.



\subsection{Dynamic Seat Assignment for Each Group Arrival}
% we make the decision according to the realized arrivals.
In this situation, we not only need to decide whether to accept or reject an arrival, but also assign seats to each group if we accept it.

\subsubsection{Group-type(Supply) Control}\label{nested_policy}

For a feasible seat planning, we must follow some basic rules to assign seats.
% Seat Planning Based Rules
\begin{itemize}
    \item When the supply of one arriving group is enough, we will accept the group directly.
    \item When the supply of one arriving group is 0, the demand can be satisfied by only one larger-size supply.
    \item When one group is accepted to occupy the larger-size seats, the rest empty seat(s) can be reserved for future demand.
\end{itemize}

We can assign the seats to the corresponding-size group. But when a group comes while the corresponding supply is 0, should we give this group to the larger-size seats? Now we demonstrate the split larger group rule for this problem.

Suppose we accept a group of $i$ to take over $(j+s)$-size seats(of group type $j$). In that case, the expected served people is $i + (j-i-s)P(D_{j-i-s} \geq x_{j-i-s}+1)$, where $i+s \leq j$, $P(D_i \geq x_i)$ is the probability of that the expected demand of group type $i$ in the following periods is no less than $x_i$, the remaining supply of group type $i$.

When a group of $i$ occupies $(j+s)$-size seats, $(j-i-s)$ seats can be provided for one group of $j-i-s$ with $s$ seats of social distancing.
Thus, the term, $P(D_{j-i-s} \geq x_{j-i-s}+1)$, indicates the probability that the demand of group type $(j-i-s)$ in the future is no less than its current remaining supply plus 1. If $j -i- s \leq 0$, this term equals 0.

Similarly, when the expected demand of a group of $j$ in the future is no less than its remaining supply currently, we would reject a group of $i$, the expected served people is $j P(D_{j} \geq x_{j})$.

Let $d(i,j)$ be the difference of expected served people between acceptance and rejection on group $i$ occupying $(j+s)$-size seats. If $j \geq i+s$, $d(i,j)$ equals $i + (j-i-s)P(D_{j-i-s} \geq x_{j-i-s}+1) - j P(D_{j} \geq x_{j})$, otherwise, $d(i,j)$ equals $i - j P(D_{j} \geq x_{j})$.

One intuitive decision is to choose the largest difference. We can obtain $d(i,j) = j P(D_{j} \leq x_{j} -1) - (j-i-s)P(D_{j-i-s} \leq x_{j-i-s}) -1$ after reformulating. Let $F_{j}(x;T_r)$ be the cumulative distribution function of the number of arrival groups $D_{j}$ in $T_r$ periods. Then $F_{j}(x; T_{r}) = P(D_{j} \leq x)$, and $D_{j}$ follows a binomial distribution $B(T_{r}, p_{j})$, where $T_{r}$ is the numebr of remaining periods.

Thus, $d(i,j) = j F_{j}(x_{j}-1; T_r) - (j-i-s) F_{j-i-s}(x_{j-i-s}; T_r) -1$. For all $j >i$, find the largest $d(i,j)$, denoted as $d(i,j^{*})$. If $d(i,j^{*}) >0$, we will place the group $i$ in $(j^{*}+s)$-size seats. Otherwise, reject the group.

% Notice that this control ensures a local optimization. 

When the number of remaining period is large, the group-type control tends to accept smaller groups by breaking the largest group. But accepting one smaller group will result in permanent loss of seats as social distance, we need to reduce the number of accepting groups and try to accept the larger-size group as many as possible. Building on that idea, we have developed a loss control strategy. This approach enables us to minimize losses and optimize resource utilization under dynamic arrival conditions.

\subsubsection{Loss Control}
To implement this policy effectively, we need to incorporate the loss control. Specifically, when there is a large number of periods remaining, we employ both group-type control and loss control strategies. However, when there are only a few periods remaining, we rely solely on group-type control to accommodate as many people as possible within the limited periods available.

Recall that the loss we defined above is the number of people lost. Denote by $l_{t}$ the loss of up to current period $t$. When the social distance is $s$, accepting one group will incur $s$ losses. Every time we break one group into smaller one, we will create another $s$ losses. According to the initial seat planning, we can obtain the ideal loss $l_{i}$. This loss is close to the optimal loss, we try to get a closer loss when we reach the final seat assignment. Thus, we can develop a loss-control. The target ratio is $\frac{l_{i}}{T}$. The ratio at period $t$ is $\frac{l_{t}}{t}$. At period $t+1$, if we accept one group according to seat planning, $l_{t+1} = l_{t} + s$; if we accept one group by breaking a larger group, $l_{t+1} = l_{t} + 2s$; if we reject the arrival, $l_{t+1} = l_{t}$. The decision rule is based on comparing the current ratio to the target ratio. If the current ratio is lower than the target ratio, we will accept the current arrival. However, if the current ratio is equal to or greater than the target ratio, we will reject the arrival.

It's difficult to achieve the ideal loss with dynamic arrivals. To accommodate more people, we only use group-type control when there are fewer remaining periods. This approach allows us to make the most of the limited periods we have and serve as many people as possible.


% Group type control can help to make the full patterns. 
% This measure try to make the largest patterns.

% We show the results of Benders and IP under this policy in section \ref{Bender_IP}.

\subsubsection{Algorithm}
The feasible seat planning can be obtained from Algorithm \ref{feasible_seat} before the group arrivals. In accordance with the group-type control and loss control policies discussed in the previous section, we determine whether to accept or reject group arrivals.

% The specific procedures are demonstrated in the above sections.

The algorithm is shown below:

\begin{algorithm}[H]
  \caption{Dynamic seat assignment algorithm}\label{algo_nested_policy}
  \begin{description}
    \item[Step 1.] Obtain the set of patterns, $\mathbf{P} = \{P_1,\ldots,P_{N}\}$, from the feasible seat planning algorithm. The corresponding aggregate supply is $\X = [x_{1}, \ldots, x_{M}]$.
    \item[Step 2.] For the arrival group type $i$ at period $T{'}$, find the first $k \in \mathcal{N}$ such that $i \in P_k$. Accept the group, update $P_{k} = P_{k}/(i)$ and $x_{i} = x_{i} -1$. Go to step 4.
    \item[Step 3.] If $i \notin P_k, \forall k \in \mathcal{N}$, find $d(i,j^{*})$. If $d(i,j^{*})>0$, find the first $k \in \mathcal{N}$ such that $j^{*} \in P_k$. Accept group type $i$ and update $P_{k} = P_{k}/(j^{*})$, $x_{j^{*}} = x_{j^{*}} -1$. Then update $x_{j-i-s} = x_{j-i-s} + 1$ and $P_{k}= P_{k} \cup (j^{*}-i-s)$ when $j^{*}-i-s > 0$. If $d(i,j^{*}) \leq 0$, reject group type $i$.
    \item[Step 4.] If $T{'} \leq T$, move to next period, set $T{'} = T{'}+1$, go to step 2. Otherwise, terminate this algorithm.
  \end{description}
\end{algorithm}

\subsection{Bid-price}

The dual problem of LP relaxation of \eqref{deter_upper} is:

\begin{equation}\label{bid-price_dual}
  \begin{aligned}
  \min \quad & \sum_{i=1}^{M} d_i z_i + \sum_{j= 1}^{N} L_j \beta_{j} \\
  \text {s.t.} \quad & z_{i} + \beta_j n_i \geq (n_i-s), \quad i \in \mathcal{M}, j \in \mathcal{N} \\
  & z_{i} \geq 0, i \in \mathcal{M}, \beta_{j} \geq 0, j \in \mathcal{N}.
  \end{aligned}
\end{equation}

When a group type $i$ arrives, we can calculate $i -\beta_{j} n_i$ for all $j$ and choose $\arg \max_{j} \{i -\beta_{j} n_i\}$ as the row to allocate that group. The bid-price control policy based on the static model is stated below.

\begin{algorithm}[H]
  \caption{Bid-price algorithm}
  \begin{description}
    \item[Step 1.] Observe the arrival group type $i$ at period $t = 1, \ldots, T$.
    \item[Step 2.] Solve \eqref{bid-price_dual} with $d_i^{t} = (T-t) \cdot p_i$ and $\mathbf{L}^{t}$, obtain an optimal solution $\beta_{j}^{t}$.
    \item[Step 3.] Set $k = \arg \max_{j} \{i -\beta_{j}^{t} n_i | n_i \mathbf{e}_{k}^{\top} \leq \mathbf{L}\}$.
    \item[Step 4.] If $i -\beta_{k}^{t} n_i \geq 0$, then assign the group to row $k$, update $\mathbf{L}^{t+1} = \mathbf{L}^{t} - n_i \mathbf{e}_{k}^{\top}$; otherwise, reject the group, let $\mathbf{L}^{t+1} = \mathbf{L}^{t}$. 
    \item[Step 5.] If $t \leq T$, move to next period, set $t = t+1$, go to step 2. Otherwise, terminate this algorithm.
  \end{description}
\end{algorithm}

\subsection{Dynamic Seat Assignment after All Group Arrivals}
In this seat assignment situation, we first decide whether to accept or reject each group arrival based on the following DP. After all group arrivals have been considered, we then assign seats to each group.

Relax all rows to one row with the same capacity by $L = \sum_{j=1}^{N} L_j$. The deterministic problem is

\begin{equation}\label{relax_deter}
  \begin{aligned}
  \max \quad & \sum_{i=1}^{M} (n_i- s) x_{i} \\
  \text {s.t.} \quad & x_{i} \leq d_{i}, \quad i \in \mathcal{M}, \\
  & \sum_{i=1}^{M} n_{i} x_{i} \leq L \\
  & x_{i} \in \mathbb{Z}_{+}, \quad i \in \mathcal{M}.
  \end{aligned}
\end{equation}

\begin{lem}
 Let $\mathbf{X}$ be the solution of linear relaxation of problem \eqref{relax_deter}. $\mathbf{X}$ is the same as the aggregate
 solution of linear relaxation of problem \eqref{deter_upper}.
\end{lem}

% We can always find the optimal solution of problem \eqref{relax_deter} for any given deterministic demand, $(d_{1}, \ldots, d_{M})$.

% Let $\mathbf{e}_{i}$ denote the unit row vector with $j$-th element being 1. Then $\mathbf{X}$ can be expressed as $x \mathbf{e}_{h} + \sum_{i=h+1} ^{M} d_{i} \mathbf{e}_{i}$, where $x = (L- \sum_{i = h+1}^{M} {d_i n_i})/ n_h$. We can transform $\mathbf{X}$ to an integral solution with optimal integral objective value.

% Let $r = (L- \sum_{i = h+1}^{M} {d_i n_i} - n_{h} \lfloor x \rfloor)$, $r$ is an integer. When $r \geq 1+s$, we can easily find $u$ such that $r = n_{u}$, then $\mathbf{e}_{u} + \lfloor x \rfloor \mathbf{e}_{h}+ \sum_{i=h+1} ^{M} d_{i} \mathbf{e}_{i}$ is an optimal solution. When $r < 1+s$, we can always find $u,v,w; u<h, v \geq h+1, w \leq h$ such that $n_{v} + r = n_{w} + n_{u}$, then $e_{w} + e_{u} -e_{v} + \lfloor x \rfloor \mathbf{e}_{h}+ \sum_{i=h+1} ^{M} d_{i} e_{i}$ is an optimal solution; when $s=1$, $u = 1, v = h+1, w =h$. 


Let $v_{r}^{*}$ and $v^{*}$ denote the optimal values of problem \eqref{relax_deter} and \eqref{deter_upper}, respectively. After relaxation, assume that each row has a capacity of $L$ seats, which can be filled. For each seperate row, the maximum number of empty seats in each row is $s$. Then, the total number of empty seats in $N$ rows is given by $Ns$. Therefore, the biggest difference between $v_{r}^{*}$ and $v^{*}$ is the number of people accommodated in the $Ns$ empty seats.
The difference between them is zero only when the groups corresponding to the optimal solution of problem \eqref{relax_deter} can be accommodated in $N$ rows. The numerical results indicate that this is the case for most scenarios, which suggests that a DP-based approach can be used to solve the dynamic seat assignment problem after all groups have arrived.


% The numerical result shows that the difference is zero for most cases, thus we can develop a dynamic programming(DP)-based method to solve dynamic seat assignment after all group arrivals.


Let $u$ denote the decision, where $u(t) = 1$ if we accept a request in period $t$, $u(t) =0$ otherwise. Similar to the DP in section \ref{sec_dynamic}, the DP with one row can be expressed as:

$$V_{t}(L) = \mathbb{E}_{i \sim p} [\max_{u \in \{0,1\}} \{ {[V_{t+1}(L-n_i u)+ i u]}\}], L \geq 0, V_{T+1}(L) =0, \forall L$$



% $\underbrace{(0, \ldots, x}_{h ~numbers},d_{h+1}, \ldots, d_{M})$
% $\underbrace{(0, \ldots, 1}_{u ~numbers}, \ldots, 0, d_{h+1}, \ldots, d_{M})$
% $\underbrace{(0, \ldots, 1}_{u ~numbers}, \ldots, 1, d_{h+1}, \ldots,d_{v}-1, \ldots, d_{M})$

% Assuming that there always exists a seat assignment under the total capacity of seats,

After accepting each group, it is necessary to ensure that the accepted groups can be feasibly assigned seats. Conducting inspections at each stage can be cumbersome. To streamline the process, a threshold capacity can be developed. When the accepted groups fall within the prescribed threshold, they can be accepted directly using DP. However, when the accepted groups exceed the prescribed threshold, feasibility must be checked and the group should be rejected if a feasible seat assignment cannot be found.

% we don't know whether the accepted groups can be assigned to seats when the demand is close to supply. 

The threshold capacity can be obtained by the following analysis. When the remaining capacity is no smaller than $n_{M}$ for any row, we can always assign any group to this row. Thus, the largest number of taken seats for row $j$ is $L_j -n_{M} +1$ to ensure the next group can be placed. For $N$ rows, the threshold capacity can be $\sum_{j=1}^{N} (L_j -n_{M} +1)$.

\subsection{}
Supply control + bid-price.

Firstly, if supply control and bid-price both decide to accept a small group, then accept it; otherwise, reject it.

$$V_{t}(L_1, L_2) = \sum_{i} p_i [\max \{ {[V_{t+1}(L_1, L_2), V_{t+1}(L_1- n_i, L_2)+ i, V_{t+1}(L_1, L_2 - n_i)+i]}\}]$$

$V_{T+1}(L_1, L_2) = 0, \forall L_1, L_2$

% \subsection{Break tie}
% To determine which row to place accepted groups in when there are multiple options, follow these steps:

% 1. Number each row in ascending order.

% 2. Prioritize placing groups in rows from smallest to largest.

% 3. Check if the remaining capacity of the current row is greater than the maximum group size or equal to the current group size. If it is, accept the current arrival and place the group in that row.

% 4. Otherwise, consider the next row with the next higher number.

% 5. Repeat steps 3 and 4 until a row is found that can accommodate the current group size.

% By following this approach, it is possible to efficiently find rows to place accepted groups while maximizing capacity utilization. This is achieved by filling as many rows as possible, starting from the row with the smallest number and only moving to the row with the larger number if necessary.


% \subsection{Seat Planning Charts Online}
% We are able to provide an online seat planning solution by using our method. For a feasible seating arrangement, we provide a pattern for each row. The sequence of groups within each pattern can be arranged arbitrarily, allowing for a flexible seat planning that can accommodate realistic operational constraints. Therefore, any fixed sequence of groups within each pattern can be used to construct a seating plan that meets practical needs.



% We need to assign seats to the group for each arrival. In each period, the group can select the row they want to sit when the capacity is enough. FCFS will be more appropriate. But M1 and M3 can also be used.


% update the scenario and the probability, add constraints when re-calculating stochastic programming.
% we can update the supply whenever some demand exceeds the supply.


% Then use Algorithm \ref{algo_nested_policy} to make the decision.


% \subsubsection{Ticket Reservation with Row Selection}
% There are two methods to achieve this goal.

% First, we can generate patterns planning according to stochastic information. Calculate the maximal supply from the mean demand. The supply gives the number of patterns with different losses; then we prepare the corresponding pattern planning for each row. Every group will be assigned in each period according to the designated row as long as the capacity allows. 

% The number of combinations is enormous.

% The second one is named the seat row selection method based on the stochastic seat assignment method. The initial supply is obtained from the stochastic model, then update the supply from the deterministic model after the first period. After accepting one group, we update the accepted demand and remaining seats. The policy follows section \ref{nested_policy}.


% Set the mean demand as the initial supply, update the supply from deterministic model by setting accpected demand as the lower bound. / can be used in scenario 1,2.


% Partially dynamic: at the beginning stage, the capacity is sufficient, thus we will accept all arrivals. 
% Multiple planning approach 


\subsection{Benchmark}
 
% The benchmarks for the above two situations are described below.

\subsubsection{FCFS}\label{largest_pattern}
For dynamic seat assignment for each group arrival, the intuitive but trivial method will be on a first-come-first-served basis. Each accepted request will be assigned seats row by row. If the capacity of a row is insufficient to accommodate a request, we will allocate it to the next available row. If a subsequent request can fit exactly into the remaining capacity of a partially filled row, we will assign it to that row immediately. Then continue to process requests in this manner until the capacity of all rows is fully utilized.


% we can continue to use the first-come, first-served approach for seat assignment across all rows. 

\subsubsection{FCFS-based}\label{FCFS-based}
For dynamic seat assignment after all group arrivals, we can continue to use the first-come, first-served approach for seat assignment. Relax all rows to one row with the total number of seats. For each arrival, we need to check the feasibility of constructing a seat assignment in $N$ rows. If the seat assignment is feasible, we accept the request; otherwise, we reject it. The threshold capacity is $(L -u +1)$.

% find the target arrival when the number of seats taken by the preceding arrivals does not exceed the capacity.Then we obtain a new sub-sequence, including the arrivals from the first to the target and a possible arrival. 

% And use the nested policy to accept or reject one group in the remaining arrivals. 


% For the convenience of calculation, we check the feasibility of constructing a seat assignment from the end of the sub-sequence. When it is not feasible for the seat assignment, we should delete the group one by one from this sub-sequence until a feasible seat assignment is found. In reality, we need to check the feasibility one group by one.



% Each request will be assigned row by row. When the capacity of one row is not enough for the request, we arrange it in the next row. If the following request can take up the remaining capacity of some row exactly, we place it in that row immediately. We check each request until the capacity is used up. 



% There is a reservation stage, we only decide to accept or reject.
% After certain periods, there is a seat selection stage.

% Or use partial static information to estimate the probabilities, then generate new plannings.

% Multiple scenario approach:
% Suppose that we know the probabilities, we can use the sampling demands to estimate which patterns we should use. For example, three rows with $I_1$, seven rows with $I_2$. For each arrival, if there exists one scenario containing this group, we accept it; otherwise we use nested policy to accept or reject it.

% \subsubsection{Largest Patterns Planning}\label{largest_pattern}
% For each row, we choose the patterns from $I_1$. Accept the group such that the largest pattern can be maintained. When the arrival cannot be assigned in the planning patterns from $I_1$, we can change the largest pattern to a second largest pattern according to the coming arrival.

% \begin{algorithm}[H]\label{algo_largest}
%   \caption{Method by using the largest patterns}
%   \begin{description}
%     \item[Step 1.] Generate the largest pattern by the greedy way for each row.
%     \item[Step 2.] Denote the minimal and maximal size of group in the pattern of row $i$ as $\min_i$ and $\max_i$. 
%     \item[Step 3.] For the arrival with the size of $a$ in period $t$, if there exists $i$ such that $\min_i + \max_i >= a$ and $a > \min_i$, accept this arrival at row $i$, go to step 5; otherwise, go to step 4.
%     \item[Step 4.] Find a maximal group of seats to accept this arrival, otherwise, reject this arrival.
%     % Use the information of realized arrivals to make the decision.
%     \item[Step 5.] Move to the next period. Repeat step 3. 
%   \end{description}
% \end{algorithm}

% Step 2: the pattern will have the same loss by these procedures. ($\min_i$ can be 0.)

% \begin{lem}
%   Any largest patterns can be generated by the largest pattern constructed from the greedy method.
% \end{lem}

% This method can be used without stochastic information. The performance will improve when the total demand can construct the largest patterns for all rows.


% Once: Obtain the supply from the stochastic model by benders decomposition. Use the deterministic model to obtain a heuristi supply. Then use the multi-class rule to decide whether to accept the group at each period.

% Several: Initially, set the mean demand for all periods as the upper bound of demand. Then obtain the supply from the deterministic model. Set the accepted demand as the lower bound of demand, the upper bound of demand will be the sum of accepted demand and mean demand for the remaining periods. Update the lower bound and upper bound when some supply runs out.

% One counterexample: [15,21,13,3] /[15,21,10,3]  reject 4

% Different types of movies will have different probabilities, consider the preference for policy when demand = supply.


% The numbers in the `performance compared to the optimal' represent M1, M2, M3, M4, M5, M6 respectively in order.

% The maximal number of people served can be obtained by \eqref{deter_upper} with a realized sequence of arrival.

% Some important information:
% The government will give the restriction: 入座人数50% /相连座位 4个
