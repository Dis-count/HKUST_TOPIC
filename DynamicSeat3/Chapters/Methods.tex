% !TEX root = sum1.tex
\section{Dynamic Seat Assignment Policy}
% identify possible rows and assign to specific row.
In this section, we discuss the dynamic seat assignment policy, which involves making decisions on seat allocations for each group arrival based on the seat planning obtained from Section 4.

When a group arrives, we first check if the corresponding supply is sufficient. If the supply is enough, we can directly accept the group and assign seats to it in the row with the corresponding supply. However, if the supply is insufficient, we need to consider alternative options. Based on our previous considerations, we know that groups can be assigned seats for a larger group type if the supply for their own group type is insufficient. To determine whether to use larger seats to accommodate the incoming group, we assess the potential benefits by comparing the expected values of accepting the group with larger seats and rejecting the group based on the current seat planning.
To make this decision, we identify the possible rows where the incoming group can be assigned based on the group types and seat availability. This policy is called group-type control, which helps us narrow down the option of rows for seat assignment.

If we make decisions based on the seat planning generated from SSP, when the corresponding supply is sufficient, we will accept the group, without considering that larger seats can accommodate smaller groups, which will result in rejecting too many smaller groups. Therefore, it is necessary to assess whether to accept a group with the larger seats based on the current seat planning. 

While it would be ideal to obtain the integral seat planning by solving the SSP directly, this may not be feasible due to the computational complexity and the need to calculate the value of the SSP for each potential seat assignment. The process of solving the integer programming and evaluating the stochastic programming value for each row is time-consuming, making it impractical for real-time decision-making.

In practice, to optimize computation cost, we can calculate the value of the linear relaxation of the SSP. This approach provides the same value under the same scenario set, regardless of which row the group is placed in. Therefore, we only need to compare the values of accepting the group at any one row with the value of rejecting the group to make a decision.

After determining the possible rows for seat assignment using the strategies mentioned earlier, we can apply a tie-breaking rule to select a specific row. This rule helps us decide on a particular row when there are multiple options available. Next, we compare the values of the stochastic programming problem when accepting the group at the chosen row versus rejecting it. This evaluation allows us to assess the potential revenues associated with each decision. Simultaneously, during this calculation, we can generate a new seat planning that reflects the acceptance or rejection of the incoming group.


By combining the group-type control strategy with the evaluation of stochastic programming values, we obtain a comprehensive decision-making process within a single stage. This integrated approach enables us to make informed decisions regarding the acceptance or rejection of incoming groups, as well as determine the appropriate row for their assignment when acceptance is the chosen option. By considering both computation time savings and potential revenues, we can optimize the overall performance of the seat assignment process.



% We need to make decisions regarding whether to use a larger group type to accommodate smaller group arrivals. This decision-making process is referred to as group-type control. Once we have determined which group type to utilize for accommodating smaller groups, we then need to compare the values of stochastic programming when accepting the group at a specific row versus denying it. This evaluation helps us assess the potential revenues of accepting or rejecting the group. During the calculation of the stochastic programming values, we can generate a new seat planning simultaneously. By integrating the group-type control and the value of stochastic programming, we can make informed decisions regarding the acceptance or rejection of an incoming group, as well as determine the appropriate row for their assignment when accepting it.



% We can estimate the arrival rate from the historical data, $p_i = \frac{N_{i}}{N_{0}}, i \in \mathcal{M}$, where $N_{0}$ is the number of total groups, $N_{i}$ is the number of group type $i$. Recall that we assume there are $T$ independent periods, with one group arriving in each period. There are $M$ different group types. Let $\mathbf{y}$ be a discrete random variable indicating the number of people in the group, and let $\mathbf{p}$ be a vector probability, where $p(y = i) = p_i$, $i \in \mathcal{M}$ and $\sum_{i} p_{i} =1$.

% Seat assignment based on stochastic assignment policy involves seat planning and 

\subsection{Group-type Control}\label{nested_policy}
Seat planning serves as a representation of the supply available for each group type. Based on the supply, we can determine whether to accept an incoming group. If there is sufficient supply available for an arriving group, we will accept the group and allocate seats accordingly. However, if there is no corresponding supply available for the arriving group, we need to decide whether to use a larger group's supply to meet the needs of the arriving group. When a group is accepted and assigned to larger-size seats, the remaining empty seat(s) can be reserved for future demand without affecting the rest of the seat planning.

Specifically, suppose the supply is $(x_1, \ldots, x_M)$ at period $t$, the number of remaining periods is $(T-t)$. For the coming group type $i$, if $x_i > 0$, then accept it, let $x_i = x_i -1$.
If $x_i = 0$, in the following part, we will demonstrate how to decide whether to accept the current group to occupy larger-size seats when there is no corresponding supply available. For any $j=i+1, \ldots, M$, we can use one supply of group type $j$ to accept a group of $i$. In that case, when $i <j < i+\delta$, the expected number of accepted people is $i$. When $i+\delta \leq j$, the rest $(j-i-\delta)$ seats can be provided for one group of $j-i-\delta$ with $\delta$ seats of social distancing. Let $D_j$ be the random variable indicates the number of group type $j$ in $(T-t)$ periods. The expected number of accepted people is $i + (j-i-\delta)P(D_{j-i-\delta} \geq x_{j-i-\delta}+1; T-t)$, where $P(D_i \geq x_i; T-t)$ is the probability of that the demand of group type $i$ in $(T-t)$ periods is no less than $x_i$, the remaining supply of group type $i$. Thus, the term, $P(D_{j-i-\delta} \geq x_{j-i-\delta}+1; T-t)$, indicates the probability that the demand of group type $(j-i-\delta)$ in $(T-t)$ periods is no less than its current remaining supply plus 1. 

Similarly, when we retain the supply of group type $j$ by rejecting a group of $i$, the expected number of accepted people is $j P(D_{j} \geq x_{j}; T-t)$. The probability, $P(D_{j} \geq x_{j}; (T-t))$, indicates the probability that the demand of group type $j$ in $(T-t)$ periods is no less than its current remaining supply.

Let $d^{t}(i,j)$ be the difference of expected number of accepted people between acceptance and rejection on group $i$ occupying $(j+\delta)$-size seats at period $t$. Then we have
\begin{equation*}
	d^{t}(i,j) = \begin{cases}
    i + (j-i-\delta)P(D_{j-i-\delta} \geq x_{j-i-\delta}+1; T-t) - j P(D_{j} \geq x_{j}; T-t), &\text{if}~ j = i+\delta, \ldots, M \\
    i - j P(D_{j} \geq x_{j}; T-t), &\text{if}~ j = i+1, \ldots, i+\delta-1.
		\end{cases}
\end{equation*}


% If $j \geq i+\delta$, $d(i,j)$ equals $i + (j-i-\delta)P(D_{j-i-\delta} \geq x_{j-i-\delta}+1; T_r) - j P(D_{j} \geq x_{j}; T_r)$, otherwise, $d(i,j)$ equals $i - j P(D_{j} \geq x_{j})$. 

One intuitive decision is to choose $j$ with the largest difference. For all $j = i+1, \ldots, M$, find the largest $d^{t}(i,j)$, denoted as $d^{t}(i,j^{*})$. If $d^{t}(i,j^{*}) >0$, we will place the group of $i$ in $(j^{*}+\delta)$-size seats. Otherwise, reject the group.

Group-type control policy can only tell us which group type will be provided for the smaller group based on the current planning, we still need to further compare the values of stocahstic programming when accepting or rejecting an group on the specific row. 


\subsection{Assign The Group to A Specific Row}
We determine whether to place the group arrival in a specific row based on the values of stochastic programming. After we plan to use the larger group to assign the arriving group, we need to compare the objective values of stochastic programming to accept or reject this group. For the objective values of stochastic programming, we need to consider the potential revenues that could result from accepting the current arrival, i.e., the Value of Acceptance (VoA), as well as the potential outcomes that could result from rejecting it, i.e., the Value of Rejection (VoR).

Let us consider two sets of scenarios, denoted as $\Omega^{t}_{A}$ and $\Omega^{t}_{R}$, at period $t$. The only difference between these two sets is the acceptance or rejection of an arrival of group type $i$ at that specific period. The VoA is calculated by considering the scenario set $\Omega^{t}_{A}$ when we accept the current arrival. This involves evaluating the stochastic programming model using the scenario set $\Omega^{t}_{A}$. On the other hand, the VoR is calculated by considering the scenario set $\Omega^{t}_{R}$ when we reject the current arrival. In this case, the stochastic programming model is evaluated using the scenario set $\Omega^{t}_{R}$, which reflects the potential outcomes when group type $i$ is rejected.

Suppose the available supply is $\mathbf{L}^{t} = (L_1^{t}, \ldots, L_N^{t})$ before making the decision. We calculate the stochastic programming with $\mathbf{L}^{t}= (L_1^{t}, \ldots, L_N^{t})$ when we reject group type $i$ as the VoR. If we decide to accept group type $i$ in row $j$ according to the group-type control policy, we need to subtract the size of group type $i$ from $L_j^{t}$. Let $L_j^{t} = L_j^{t} - n_{i}$, then we calculate the stochastic programming with $\mathbf{L}^{t}= (L_1^{t}, \ldots, L_N^{t})$ when we accept group type $i$ in row $j$ as the VoA.

By comparing the VoA and the VoR, we can make an decision about whether to accept or reject the arrival based on which option has the higher expected value. If the VoA is larger than the VoR, it indicates that accepting the arrival would result in a higher objective value. If the VoA is less than the VoR, we will reject the incoming group.

% This adjustment ensures that the stochastic programming model captures the impact of rejecting group type $i$ on the remaining seats. 

% In such cases, we refer to the corresponding planning group row in the group-type control, where we determine which group to break in order to accommodate the incoming group. 

In essence, this decision-making approach weighs the potential benefits associated with accepting or rejecting an arrival, allowing us to select the option that maximizes the objective value and aligns with our overall goals.

% When a new seat planning can be regenerated, we can use the objective value of stochastic programming to make the decision.

\subsection{Algorithm of Dynamic Seat Assignment Policy}
To optimize computational efficiency, it is not necessary to regenerate the seat planning for every period. Instead, we can employ a more streamlined approach. When the available supply is sufficient to accommodate an arriving group, we can directly assign the group seats and update the remaining supply accordingly.

Considering that larger group types can cover the needs of smaller group types, thus, if the supply for the largest group type diminishes from one to zero, it becomes necessary to regenerate the seat planning. This ensures that we maintain an accurate supply for all group types.
Another situation that requires seat planning regeneration is when we assign a smaller group type to a larger group, and the resulting pattern may no longer be the largest or full. In such case, it becomes necessary to compare the VoA and VoR to make informed decisions. We can also obtain the corresponding seat planning after solving the stochastic programmings. By regenerating the seat planning in such situations, we ensure that we have an accurate supply and can give the allocation of seats based on the group-type control and the comparisons of VoA and VoR.


% There is one exception to regenerating the seat planning, which occurs when the arriving group is the largest and the corresponding supply is only 1. In this case, after accepting the largest group, the supply becomes 0, necessitating the generation of a new seat planning.

% The seat planning can be obtained from Algorithm \ref{seat_construction}. In accordance with the group-type control discussed in the previous section, we determine whether to accept or reject group arrivals and which row to assign the group in.

{\bf{Break Tie for Dynamic Seat Assignment Policy}}

A tie occurs when there are serveral rows to accommodate the group. When the supply is sufficient for the group type, we assign the group at a row with the smallest remaining capacity. 
When the supply is insufficient and the small group is planned to be assigned to the seats for larger groups, we assign the group at a row that contains at least two planned groups, including this larger group. If the row does not exist, we assign the group at a row that contains the larger group and have the smallest remaining capacity.
By following this approach, the number of unused seats in each row can be reduced, leading to better capacity utilization.


\begin{algorithm}[h]
  \caption{Dynamic Seat Assignment}\label{algo_dynamic_policy}
  \KwIn{Seat planning $\bm{H}$, Supply $\bm{X}$, $\mathbf{L}$}
  \KwOut{Decision}
  \For{$t =1, \ldots, T$}
  { Observe group type $i$\;
    \eIf{$X_{i} > 0$}
    {Find row $k$ such that $H_{ki} >0$ according to tie-breaking rule\; Accept group type $i$ in row $k$, $L_{k} \gets L_{k} -n_{i}$\; $H_{ki} \gets H_{ki} -1$, $X_{i} \gets X_{i} -1$\Comment*[r]{Accept group type $i$ when the supply is sufficient}
    \If{$i = M$ and $X_{M} =0$}
    {Regenerate $\bm{H}$ from Algorithm 3\; Update the corresponding $\bm{X}$\Comment*[r]{Regenerate the seat planning when the supply of the largest group type is 0}}
    }
    {Calculate $d^{t}(i, j^{*})$\;
    \eIf{$d^{t}(i, j^{*}) >0 $}
    {Find row $k$ such that $H_{kj^{*}} > 0$ according to tie-breaking rule\; 
    Calculate the VoA under scenario $\Omega^{t}_{A}$ and the VoR under scenario $\Omega^{t}_{R}$\;
    \eIf{VoA $>$ VoR}
    {Accept group type $i$, $L_{k} \gets L_{k} - n_{i}$\; Regenerate $\bm{H}$ from Algorithm 3\; Update the corresponding $\bm{X}$\;}
    {Reject group type $i$\; Regenerate $\bm{H}$ from Algorithm 3\; Update the corresponding $\bm{X}$\;}}
    {Reject group type $i$\;}
    }}
\end{algorithm}




% \subsection{Break tie for Bid-price and DP base-heuristic}
% To determine which row to place accepted groups in when there are multiple options, follow these steps:

% 1. Check if the remaining capacity of the current row is greater than the maximum group size or equal to the current group size. If it is, accept the current arrival and place the group in that row.
% 2. Otherwise, consider the next row.
% 3. Repeat steps 3 and 4 until a row is found that can accommodate the current group size.



% \subsection{Seat Planning Charts Online}
% We are able to provide an online seat planning solution by using our method. For a feasible seating arrangement, we provide a pattern for each row. The sequence of groups within each pattern can be arranged arbitrarily, allowing for a flexible seat planning that can accommodate realistic operational constraints. Therefore, any fixed sequence of groups within each pattern can be used to construct a seating plan that meets practical needs.

% We need to assign seats to the group for each arrival. In each period, the group can select the row they want to sit when the capacity is enough. FCFS will be more appropriate. But M1 and M3 can also be used.


% update the scenario and the probability, add constraints when re-calculating stochastic programming.
% we can update the supply whenever some demand exceeds the supply.

% Then use Algorithm \ref{algo_nested_policy} to make the decision.


% \subsubsection{Ticket Reservation with Row Selection}
% There are two methods to achieve this goal.

% First, we can generate patterns planning according to stochastic information. Calculate the maximal supply from the mean demand. The supply gives the number of patterns with different losses; then we prepare the corresponding pattern planning for each row. Every group will be assigned in each period according to the designated row as long as the capacity allows. 

% The number of combinations is enormous.

% The second one is named the seat row selection method based on the stochastic seat assignment method. The initial supply is obtained from the stochastic model, then update the supply from the deterministic model after the first period. After accepting one group, we update the accepted demand and remaining seats. The policy follows section \ref{nested_policy}.


% Set the mean demand as the initial supply, update the supply from deterministic model by setting accepted demand as the lower bound. / can be used in scenario 1,2.


% Partially dynamic: at the beginning stage, the capacity is sufficient, thus we will accept all arrivals. 
% Multiple planning approach


% \subsubsection{FCFS-based}\label{FCFS-based}
% For dynamic seat assignment after all group arrivals, we can continue to use the first-come, first-served approach for seat assignment. Relax all rows to one row with the total number of seats. For each arrival, we need to check the feasibility of constructing a seat assignment in $N$ rows. If the seat assignment is feasible, we accept the request; otherwise, we reject it. The threshold capacity is $(L -u +1)$.

% find the target arrival when the number of seats taken by the preceding arrivals does not exceed the capacity.Then we obtain a new sub-sequence, including the arrivals from the first to the target and a possible arrival. 

% And use the nested policy to accept or reject one group in the remaining arrivals. 


% For the convenience of calculation, we check the feasibility of constructing a seat assignment from the end of the sub-sequence. When it is not feasible for the seat assignment, we should delete the group one by one from this sub-sequence until a feasible seat assignment is found. In reality, we need to check the feasibility one group by one.


% Each request will be assigned row by row. When the capacity of one row is not enough for the request, we arrange it in the next row. If the following request can take up the remaining capacity of some row exactly, we place it in that row immediately. We check each request until the capacity is used up. 



% There is a reservation stage, we only decide to accept or reject.
% After certain periods, there is a seat selection stage.

% Or use partial static information to estimate the probabilities, then generate new plannings.

% Multiple scenario approach:
% Suppose that we know the probabilities, we can use the sampling demands to estimate which patterns we should use. For example, three rows with $I_1$, seven rows with $I_2$. For each arrival, if there exists one scenario containing this group, we accept it; otherwise we use nested policy to accept or reject it.

% \subsubsection{Largest Patterns Planning}\label{largest_pattern}
% For each row, we choose the patterns from $I_1$. Accept the group such that the largest pattern can be maintained. When the arrival cannot be assigned in the planning patterns from $I_1$, we can change the largest pattern to a second largest pattern according to the coming arrival.

% \begin{algorithm}[H]\label{algo_largest}
%   \caption{Method by using the largest patterns}
%   \begin{description}
%     \item[Step 1.] Generate the largest pattern by the greedy way for each row.
%     \item[Step 2.] Denote the minimal and maximal size of group in the pattern of row $i$ as $\min_i$ and $\max_i$. 
%     \item[Step 3.] For the arrival with the size of $a$ in period $t$, if there exists $i$ such that $\min_i + \max_i >= a$ and $a > \min_i$, accept this arrival at row $i$, go to step 5; otherwise, go to step 4.
%     \item[Step 4.] Find a maximal group of seats to accept this arrival, otherwise, reject this arrival.
%     % Use the information of realized arrivals to make the decision.
%     \item[Step 5.] Move to the next period. Repeat step 3. 
%   \end{description}
% \end{algorithm}

% Step 2: the pattern will have the same loss by these procedures. ($\min_i$ can be 0.)

% \begin{lem}
%   Any largest patterns can be generated by the largest pattern constructed from the greedy method.
% \end{lem}

% This method can be used without stochastic information. The performance will improve when the total demand can construct the largest patterns for all rows.


% Once: Obtain the supply from the stochastic model by benders decomposition. Use the deterministic model to obtain a heuristi supply. Then use the multi-class rule to decide whether to accept the group at each period.

% Several: Initially, set the mean demand for all periods as the upper bound of demand. Then obtain the supply from the deterministic model. Set the accepted demand as the lower bound of demand, the upper bound of demand will be the sum of accepted demand and mean demand for the remaining periods. Update the lower bound and upper bound when some supply runs out.

% One counterexample: [15,21,13,3] /[15,21,10,3]  reject 4

% Different types of movies will have different probabilities, consider the preference for policy when demand = supply.


% The numbers in the `performance compared to the optimal' represent M1, M2, M3, M4, M5, M6 respectively in order.

% The maximal number of people served can be obtained by \eqref{deter_upper} with a realized sequence of arrival.

% Some important information:
% The government will give the restriction: 入座人数50% /相连座位 4个
