% largest pattern 唯一 拆开来写  问题的一般性描述，结果 <-> 算法.

\subsection{[a,b]}

\begin{lem}
For $[2,3]$, we can obtain an optimal assignment by the policy.
\end{lem}

The following procedure can generate an optimal assignment.

% In fact, if we only have two types of group size, we can use column generation
% obtain the results directly. Or generate the pattern greedily.

% One result is that we will satisfy 3 first.

Suppose the group sizes are $2,3$ and the demand is $d_2,d_3$, respectively. We have $N$ rows initially.

If $S \div 3 = q \ldots 1$, the largest patterns will be $(3,3,\ldots,3,2,2), (3,3,\ldots,3,1)$. %need to explain the priority.
If $S \div 3 = q \ldots 2$, the largest pattern will be $(3,3,\ldots,3,2)$.
If $S \div 3 = q $, the largest pattern will be $(3,3,\ldots,3)$.

According to the value of $S$, repeat the largest pattern until $q > d_3$ or $d_2 =0$.
When $q > d_3$, just place groups with 3 $d_3$ times, the rest space will be placed by groups with 2. When $d_2 =0$, just place groups with 3 only.
In the way, we can obtain the optimal scheme.

For example, $S \div 3 = q \ldots 1$, each row will be divided by $(q-1)\times 3, 2\times 2$, thus we need to find the smaller one, $\min\{\lfloor\frac{d_3}{q-1}\rfloor, \lfloor\frac{d_2}{2}\rfloor \}$, denoted by $r$. If $r \geq N$, choose the largest pattern $N$ times. If $r< N$, when $\lfloor\frac{d_3}{q-1}\rfloor$ is smaller, the number of remaining groups with 3 is $d_3 - \lfloor\frac{d_3}{q-1}\rfloor * (q-1)$.

When $\lfloor\frac{d_2}{2}\rfloor$ is smaller, the number of remaining groups with 2 is $d_2 - \lfloor\frac{d_2}{2}\rfloor * 2$(0 or 1). Retain the group with 2, then place groups with 3 repeatedly.

% 2) the number of 5 and 6 is less than something, estimate the occupancy.
The conclusion can be extended to any two types of group size. But we still need to consider the number of the largest pattern and the demands of group sizes.

As long as we can obtain the maximum number of the largest patterns with some demands, we will obtain an optimal assignment.

\begin{lem}
For $[4,5]$, only when $r=1$, we have two largest patterns,
  $(5,\ldots,5,1)$ and $(5,\ldots,5,4,4,4,4)$.

For $[3,5]$, when $r=1$, we have two largest patterns, $(5,\ldots,5,1)$ and $(5,\ldots,5,3,3)$. When $r=4$, we have two largest patterns, $(5,\ldots,5,3,1)$ and $(5,\ldots,5,3,3,3)$, which depends on $D_3,D_5$.

For $[2,5]$, we don't have two largest patterns.

For $[2,4]$, we don't have two largest patterns.

For $[3,4]$, only when $r=1$, we have two largest patterns, $(4,\ldots,4,1)$ and $(4,\ldots,4,3,3,3)$.

For $[2,3]$, only when $r=1$, we have two largest patterns, $(3,\ldots,3,1)$ and $(3,\ldots,3,2,2)$.
\end{lem}

\begin{thm}
For two types of group size,$[a,b], a < b \leq 5$, we can obtain an optimal assignment by following our policy.
\end{thm}

\begin{algorithm}[H]\label{algo2}
\caption{Construct an optimal assignment for $[a,b], 2 \leq a<b \leq 5$}
\begin{description}
  \item[Step 1.] Generate all the largest patterns, $k_i,i=1,2,\ldots,l$ when given $S$, $[a,b]$, $(d_a,d_b)_D$, $n$ rows.
  \vspace{10pt}
  \item[Step 2.] According to the demands, obtain the priority of the largest patterns, suppose the priority be $k_1 \succeq k_2 \succeq \ldots \succeq k_l$.
	\vspace{10pt}
  \item[Step 3.] Fill the rows with the largest patterns until we cannot obtain the largest pattern. Suppose the number of rows is $m$. When $m \geq n$, we have obtained an optimal assignment. When $m <n$, continue Step 4.
  \item[Step 4.] Generate the largest pattern in the greedy way. Place the corresponding groups in the $(m+1)$-st row. One of the group sizes will run out.
  \item[Step 5.] Place groups with size of $a$ or $b$ in the remaining $n-(m+1)$ rows.
\end{description}
\end{algorithm}

% 3. Theorem:  Add one row, the number of people will decrease, the assignment is still optimal. f_1 < g_1  f_1 + f_2 < g_1+ g_2

Why (3,3,3,1) will be worse than (3,3,2,2)?
Just consider this case: We have 10 groups with 2, 6 groups with 3, the length for each row is 10. For the first policy, when we need 3 rows to place, the result will be (3,3,3,1)*2, (2,2,2,2,2). But the second policy will give a better result, (3,3,2,2)*3. The reason is 1 space will be wasted by (3,3,3,1).

Notice that the group with size of $a$ can provide a profit of $(a-1)$, thus placing the group with the largest size as many as possible can make a larger profit.

\begin{algorithm}[H]\label{algo3}
\caption{Construct an optimal assignment for $[a,b,c], 2 \leq a<b<c \leq 5$}
\begin{description}
  \item[Step 1.] Generate all the largest patterns, $k_i,i=1,2,\ldots,l$ when given $S$, $[a,b,c]$, $(d_a,d_b,d_c)_D$, $n$ rows.
  \vspace{10pt}
  \item[Step 2.] According to the demands, obtain the priority of the largest patterns, suppose the priority be $k_1 \succeq k_2 \succeq \ldots \succeq k_l$.
	\vspace{10pt}
  \item[Step 3.] Fill the rows with the largest patterns until we cannot obtain the largest pattern. Suppose the number of rows is $m$. When $m \geq n$, we have obtained an optimal assignment. When $m <n$, continue Step 4.
  \item[Step 4.] Generate the largest pattern in the greedy way. Place the corresponding groups in the $(m+1)$-st row. One of the group sizes will run out.
  \item[Step 5.] We use Algorithm ~2 to solve the case of two group sizes.
\end{description}
\end{algorithm}

\subsection{[a,b,c]}

\begin{thm}
  For any $[a,b,c], 2 \leq a <b <c \leq 5$, we can obtain an optimal assignment by the following policy.
\end{thm}

\subsubsection{[2,3,4]}

\begin{thm}\label{234case}
The following policy will give an optimal assignment for [2,3,4].
\end{thm}

Suppose the demands for each group type are positive and $D_2,D_3,D_4$, respectively. The number of seats for each row is $S$. We have $n$ rows at the beginning. Let $S = 4 \times q +r, q = \lfloor \frac{S}{4} \rfloor$.

If $r = 0$, the largest pattern will be $(4,4,\ldots,4)$;

If $r = 1$, the largest pattern will be $(4,\ldots,4,1),(4,\ldots,4,3,2),(4,\ldots,4,3,3,3)$; Let $t$ be the number of 4 in pattern $(4,\ldots,4,3,3,3)$.
When $\min\{\lfloor \frac{D_4}{t} \rfloor, D_2\} > \lceil \frac{D_3}{3} \rceil$, we select $(4,\ldots,4,3,2)$; otherwise, we select $(4,\ldots,4,3,3,3)$.

If $r = 2$, the largest pattern will be $(4,\ldots,4,3,3),(4,\ldots,4,4,2)$, we will select $(4,\ldots,4,3,3)$;

If $r = 3$, the largest pattern will be $(4,\ldots,4,3)$;

Repeat to generate the largest pattern until we do not have enough demands.
If any one of demands for group types runs out, the problem is reduced to the case of two group types, use the above method to solve this case.

Now suppose the rest demands are $d_2^{l},d_3^{l},d_4^{l}$ after deducting the demands of the largest patterns.
% Let $p$ be the number of rows where we placed groups.
% $p = \lfloor \frac{D_4}{q} \rfloor$, then $d_4^{l} = D_4 - p \times q$.

$d_4^{l}$ should be less than $q$ for $r=0,3$, less than $q-1$ for $r=1,2$, otherwise, we can continue to generate the largest pattern.

For the next row, we place all rest $d_4^{l}$ groups with size of 4. Then we will have $S^{l} = S - d_4^{l} \times 4$ empty seats. The problem can be reduced to the case of two group types. That is, place groups with size of 3 as many as possible, the rest seats can be taken by group with size of 2.

For the rest $(n-p-1)$ rows, this problem is reduced to the case of two group types.

\begin{lem}\label{4case}
For the case $r=2$, $(4,\ldots,4,3,3)$ will give an assignment no worse than that of $(4,\ldots,4,2)$.
\end{lem}

\begin{pf}[Proof of lemma \ref{4case}]

Let $d_i(n), i =2,3,4$ indicate the number of demand which can be satisfied by the first policy when placing n rows. Denote by $d_i^{'}(n), i =2,3,4$ the number of demand when we take the second policy.

There are three stages to satisfy demands for n rows. The first one is to generate the largest pattern until we cannot get the largest pattern. The second one is to satisfy the group with largest size. The third one is to satisfy the left two types of demands.

If the first stage can cover n rows for both policies. These two policies will have no difference because they both give the largest pattern.

If the second policy cannot generate the largest pattern, but the first policy can generate the largest pattern, the first policy will give a better solution than the second one.

If the first policy cannot generate the largest pattern, $(4,\ldots,4,3,3)$, but the second policy can generate the largest pattern, it means $D_3- d_3 < 2$. Notice that the first policy will satisfy less groups with 4. Because the remaining demands, $D_4 - d_4$,$D_2 - d_2$ will be larger than those of the second one, the first policy can generate $(4,\ldots,4,2)$ as the largest pattern until both of them cannot generate the largest pattern.

If both policies cannot generate the largest pattern in stage two, for the second policy, it means $D_4 - d_4^{'} <q$ or $D_2 = d_2^{'}.$

When $D_4 - d_4^{'} \geq q$, the first policy can always generate $(4,\ldots,4,2)$, thus $D_4 - d_4^{'} <q$ and $D_4 - d_4 <q$ always hold.

In this way, $D_4$ will be satisfied in stage two. But $d_2 \leq d_2^{'}$, with the same rows, $d_3 \geq d_3^{'}$. Thus, the first policy will give a solution no worse than that of the second policy.

In stage three, $D_3- d_3$ will be satisfied until all $D_3$ are satisfied. But before that, $d_2 \leq d_2^{'}$ and $d_3 \geq d_3^{'}$ will hold.

Therefore, the first policy will give a solution no worse than that of the second policy.

\end{pf}

A case will show that. We have the demands, (10,6,4) for [2,3,4] respectively. The length of each row is 14. We need to arrange them on two rows. If we take $(4,\ldots,4,2)$, the solution will be (4,4,4,2) and (4,3,3,3). If we take $(4,\ldots,4,3,3) $, the solution will be (4,4,3,3)*2, which is better than the former one.

Similarly, we have the following lemma.

\begin{lem}
For the case $r=1$, $(4,\ldots,4,3,2),(4,\ldots,4,3,3,3)$ will be better than $(4,\ldots,4,1)$. Let $t$ be the number of 4 in pattern $(4,\ldots,4,3,3,3)$.
When $\min\{\lfloor \frac{D_4}{t} \rfloor, D_2\} > \lceil \frac{D_3}{3} \rceil$, we select $(4,\ldots,4,3,2)$; otherwise, we select $(4,\ldots,4,3,3,3)$.
\end{lem}

Example:

(10,3,7) for [2,3,4], length is 13, n=4. (4,4,3,2) is better than (4,3,3,3).

(10,2,8) for [2,3,4], length is 13, n=2. (4,3,3,3) is better than (4,4,3,2).

\begin{pf}[Proof of Theorem \ref{234case}]
Suppose the demands for each group type are positive and $D_2,D_3,D_4$, respectively. The number of seats for each row is $S$. We have $N$ rows at the beginning. Let $S = 4 \times q +r, q = \lfloor \frac{S}{4} \rfloor$. Let $d_i(n), i =2,3,4$ indicate the number of demand which can be satisfied by the policy when placing $n$ rows.

There are three stages to satisfy demands for n rows. The first one is to generate the largest pattern until we cannot get the largest pattern. The second one is to satisfy the group with largest size. The third one is to satisfy the left two types of demands.

If the first stage can cover $N$ rows for this policy. It is easy to know that this policy give an optimal assignment.

Suppose the number of rows can be covered in the first stage is $m$.

If $D_2 = d_2(m)$ or $D_3 = d_3(m)$, just follow the policy of two types of group in the second stage.

If $D_2 - d_2(m)>0$ and $D_3 - d_3(m)>0$, we know that $D_4 - d_4(m) < q$. Thus, one row will satisfy the left demand, $D_4 - d_4(m)$ and then place group with 3 as many as possible, if the left demand $D_3 - d_3(m)$ is also satisfied, then place group with 2 as many as possible.
% (Because 3+2>2+2+2)

$D_4$ will be satisfied in the second stage, and the demand, $d_3(m+1)$ will also be satisfied as many as possible. Thus, the policy gives the largest $d_4(m+1), d_3(m+1)$, which corresponds to an optimal solution.

In the third stage, follow the policy of two types of group, $d_4(n),d_3(n),N \geq n>m+1$ will still be the largest.

Thus, the policy will give an optimal solution.

\end{pf}


% (6,8,10,35)  The largest pattern is not easy to obtain.

% Suppose the length of each row is $S$, the largest seats can be taken by $(a,b,c)$ are $S_1$.
%
% Let $ax + by + cz = S_1, a<b<c$, the loss for the largest pattern is $x+y+z+S-S_1$.
%
% $\min (x+y+z+S-S_1) \to \min (x+y+z-S_1) \to \min (x+y+z-(ax + by + cz)) \to \max (a-1)x + (b-1)y + (c-1)z$, it is the maximal number of people served for each row.
%
% \begin{lem}
% When $ax+cz = (x+z)b$, the number of different largest patterns is at most $\frac{1}{(x+z)}\lfloor\frac{S}{b}\rfloor +1$.
% \end{lem}
% % is at most $\frac{1}{2}\lfloor\frac{S}{b}\rfloor +1$
%
% \begin{lem}
% When $ax+cz \neq (x+z)b$, the number of different largest patterns is at most a.
% \end{lem}
%
% Suppose one largest pattern is $[x_1,y_1,z_1]$ and the number of left seats is $s_1, s_1 < a$.
%
% If $z_1 =0, s_1=0$, then $ax_1 +by_1 =S$, we do not have another integer solution for this linear equation.Thus, we only have one largest pattern in this case.
%
% If $z_1 =0, s_1>0$, when $(t-1)b = ta+1$, $[x_1+t,y_1-(t-1),z_1]$ will be another largest pattern and the number of left seats is $s_1-1$. When $s_1 = a-1$, the number of largest patterns can reach $a$.
%
% When $z_1 >0$, if we decrease $z_1$ by 1, then we must increase $a$ or $b$ or both. In this way, $s_1$ will change correspondingly.
%
% Note that $ax+cz \noteq (x+z)b$, we cannot decrease b by $(x+z)$ and increase a by $x$, c by $z$.
%
% After obtaining the largest patterns, we need to compare the demands of $a,b,c$, then construct the largest patterns as many as possible.

\subsubsection{[2,3,5]}

For $[2,3,5]$, as long as we can gaurantee that $d_5,d_3$ are always largest during generating patterns, we can say our policy can give an optimal solution.

% Always placing the groups with the largest size can make sure that $d_3,d_5$ are largest.
% Because placing the groups with the largest size will be no worse than the second largest pattern.

1) When $r = 1$, the largest patterns are $(5,\ldots,5,1),(5,\ldots,5,3,3)$.

For this case, $(5,\ldots,5,3,3)$ is always no worse than $(5,\ldots,5,1)$.

After generating all $(5,\ldots,5,3,3)$, either the number of groups with 5 or 3 is not enough. Continue to place groups with 5 for each row until the group with 5 is not available. Because in this way, we can gaurantee the pattern generated for each row is no worse than others and $d_3,d_5$ are always largest.

2) When $r=2$, the largest pattern is $(5,\ldots,5,2)$.

After generating all $(5,\ldots,5,2)$, continue to place groups with 5 for each row until the group with 5 is not available. In this way, we will generate $(5,\ldots,5)$, which has the same profit with $(5,\ldots,5,3,3)$.
When the group with 5 is not available, continue to place the group with 3 for each row. $d_3,d_5$ will still be largest.

3) When $r=3$, the largest pattern is $(5,\ldots,5,3)$

When the group with 3 is not available, generate $(5,\ldots,5,2)$.

When the group with 5 is not available, continue to place the group with 3 for each row.

All in all, always placing the groups with the largest size can make sure that
$d_3,d_5$ are the largest.

4) When $r=4$, the largest patterns are $(5,\ldots,5,3)$, $(5,\ldots,5,2,2)$.

$(5,\ldots,5,3) \succeq (5,\ldots,5,2,2)$.

Placing the groups with the available largest size can make sure that $d_3,d_5$ are the largest.

5) When $r=5$, the largest pattern is $(5,\ldots,5,5)$.

When we cannot generate $(5,\ldots,5,5)$, place the group with 3 for each row. Filling the groups with 3 as many as possible into each row can always give the largest profit.

\subsubsection{[2,4,5]}

For $[2,4,5]$, as long as we can gaurantee that $d_5,d_4$ are always largest during generating patterns, we can say our policy can give an optimal solution.

1) When $r = 1$, the largest patterns are $(5,\ldots,5,1), (5,\ldots,5,4,2), (5,\ldots,5,4,4,4,4)$.

For $(\underbrace{5,\ldots,5}_{t},4,2)$, when $\min\{\lfloor \frac{D_5}{t} \rfloor, D_2\} > \lceil \frac{D_4}{4} \rceil$, we select $(5,\ldots,5,4,2)$; otherwise, we select $(5,\ldots,5,4,4,4,4)$.

$(5,\ldots,5,4,4,4,4), (5,\ldots,5,4,2) \succeq (5,\ldots,5,1)$.

When $(5,\ldots,5,4,4,4,4)$ is not available, the number of groups with 4 is less than 4.

When all largest patterns are not available, place the groups with 5 as many as possible.


2) When $r=2$, the largest patterns are $(5,\ldots,5,2), (5,\ldots,5,4,4,4)$.

For this case, $(5,\ldots,5,4,4,4) \succeq (5,\ldots,5,2)$.


3) When $r=3$, the largest pattern is $(5,\ldots,5,4,4)$.

For this case, when the group with 4 is less than 2, the second largest pattern $(5,\ldots,5,2)$ will be no worse than $(5,\ldots,5,4,2,2)$.
When the group with 5 is not enough to generate $(5,\ldots,5,4,4)$, $d_4,d_5$ will be largest when placing the available largest pattern.
Thus, placing the available largest pattern as many as possible will still give an optimal solution.

4) When $r=4$, the largest pattern is $(5,\ldots,5,4)$. Continue to generate the second largest pattern, we can ensure $d_5(n), d_4(n)$ will be the largest when given n rows.

5) When $r=5$, the largest pattern is $(5,\ldots,5,5)$.

\subsubsection{[3,4,5]}

For $[3,4,5]$, as long as we can gaurantee that $d_5,d_4$ are always largest during generating patterns, we can say our policy can give an optimal solution.

1) When $r = 1$, the largest patterns are $(5,\ldots,5,1), (5,\ldots,5,3,3), (5,\ldots,5,4,4,3), (5,\ldots,5,4,4,4,4)$.

In this case, $(5,\ldots,5,4,4,4,4)$ will have the highest priority, because
other patterns will have a lower occupancy.

$(5,\ldots,5,4,4,4,4) \succeq (5,\ldots,5,4,4,3) \succeq (5,\ldots,5,3,3)$.


2) When $r=2$, the largest patterns are $(5,\ldots,5,4,3), (5,\ldots,5,4,4,4)$.

For $(\underbrace{5,\ldots,5}_{t},4,3)$, when $\min\{\lfloor \frac{D_5}{t} \rfloor, D_3\} > \lceil \frac{D_4}{3} \rceil$, we select $(5,\ldots,5,4,3)$; otherwise, we select $(5,\ldots,5,4,4,4)$.

Similar to the case, $[2,3,4]$.

3) When $r=3$, the largest patterns are $(5,\ldots,5,3), (5,\ldots,5,4,4)$

For this case, $(5,\ldots,5,4,4) \succeq (5,\ldots,5,3)$. Because these two patterns are independent.

4) When $r=4$, the largest pattern is $(5,\ldots,5,4)$. Continue to generate the second largest pattern, we can ensure $d_5(n), d_4(n)$ will be the largest when given n rows.

5) When $r=5$, the largest pattern is $(5,\ldots,5,5)$. Similar to 4).

\subsection{[2,3,4,5]}

Example:
$[2,3,4,5] * (8,8,3,7)_D, S = 16, n=4$

The same policy will give the demand $(4,3,3,7)_{D_p}$.

The optimal solution has the demand $(0,7,2,7)_{D_o}$.

\begin{thm}
  Let $r$ be the remainder of $S$ divided by 5, i.e., $S = 5 \times q +r, q = \lfloor \frac{S}{5} \rfloor$.
  The most preferred pattern is $(5,\ldots,5,\underbrace{4,\ldots,4}_{5-r}), r =2,3,4$. When $r=0$, The most preferred pattern is $(5,\ldots,5)$. When $r=1$, The most preferred pattern is $(5,\ldots,5,4,2)$ or $(5,\ldots,5,4,4,4,4)$, which depends on the demands.
\end{thm}

We can have the following 5 situations according to the remainder.

1) When $r = 1$, the largest patterns are $(5,\ldots,5,1), (5,\ldots,5,4,2),(5,\ldots,5,3,3), (5,\ldots,5,4,4,3), (5,\ldots,5,4,4,4,4)$.

We have $(5,\ldots,5,4,4,4,4) \succeq (5,\ldots,5,4,4,3) \succeq (5,\ldots,5,3,3), (5,\ldots,5,4,2) \succeq (5,\ldots,5,1)$.

% In this case, $(5,\ldots,5,4,4,4,4)$ will have the highest priority, because other patterns will have a group with 3 or less, having the lower occupancy. We can always construct a counter example to prove $(5,\ldots,5,4,4,4,4)$ is better than others.

Notice that $(5,\ldots,5,4,4,4,4) + (5,\ldots,5,3,3) = 2* (5,\ldots,5,4,4,3)$, and $(5,\ldots,5,4,4,3)$ uses less the group with 3 than $(5,\ldots,5,3,3)$, thus $(5,\ldots,5,4,4,3) \succeq (5,\ldots,5,3,3)$.

For $(\underbrace{5,\ldots,5}_{t},4,2)$, when $\min\{\lfloor \frac{D_5}{t} \rfloor, D_2\} > \lceil \frac{D_4}{4} \rceil$, we select $(5,\ldots,5,4,2)$; otherwise, we select $(5,\ldots,5,4,4,4,4)$.

$(5,\ldots,5,1)$ will have the lowest priority because one empty seat is wasted.

2) When $r=2$, the largest patterns are $(5,\ldots,5,2), (5,\ldots,5,4,3), (5,\ldots,5,4,4,4)$.

For this case, $(5,\ldots,5,4,4,4), (5,\ldots,5,4,3) \succeq (5,\ldots,5,2)$.

For $(\underbrace{5,\ldots,5}_{t},4,3)$, when $\min\{\lfloor \frac{D_5}{t} \rfloor, D_3\} > \lceil \frac{D_4}{3} \rceil$, we select $(5,\ldots,5,4,3)$; otherwise, we select $(5,\ldots,5,4,4,4)$.

3) When $r=3$, the largest patterns are $(5,\ldots,5,3), (5,\ldots,5,4,4)$

For this case, $(5,\ldots,5,4,4) \succeq (5,\ldots,5,3)$.

4) When $r=4$, the largest pattern is $(5,\ldots,5,4)$. Continue to generate the second largest pattern, we can ensure $d_5(n), d_4(n)$ will be the largest when given n rows.

5) When $r=5$, the largest pattern is $(5,\ldots,5,5)$. Similar to 4).

Now we need to consider the situation where we cannot generate the largest patterns.

If all types of groups remain, i.e., $D_i - d_i >0, i=21,3,4,5$, we need to place the groups according to their sizes. Then $D_5$ will be satisfied and the problem is reduced to the case with $[2,3,4]$.

If $d_5 = D_5$ initially, the problem will be reduced to the case with $[2,3,4]$.

If the group with the size of 5 remains and the demand of at least one other type of group is satisfied, i.e., we have $[2,3,5]$ or $[2,4,5]$ or $[3,4,5]$.

With the above conclusions, we can follow the policies to obtain an optimal solution.

\subsubsection{Column-and-cut generation}

Notice that $T$ is a subset of the set of all possible cutting patterns, thus we need to find more cutting patterns by the column generation.


The linear relaxation of problem \eqref{deterministic_form} can be written as:

\begin{equation}\label{linear_relaxation}
  \begin{aligned}
    \max \quad & c{'} \mathbf{x} + f{'} \mathbf{y} \\
    \text {s.t.} \quad & \mathbf{T} \mathbf{x} + \mathbf{V}_\omega \mathbf{y}_\omega = \mathbf{D}_\omega, \omega\in \Omega \\
    & \mathbf{1} \mathbf{x} = N \\
    & \mathbf{x}, \mathbf{y} \geq \mathbf{0}
  \end{aligned}
\end{equation}

Obtain the dual of the problem \eqref{linear_relaxation}, the constraints are represented in the matrix form:

$$
\left[\begin{array}{cccccccccc}
\mathbf{T} & \mathbf{T} & & & \cdots & & & & \mathbf{T}  & \mathbf{1} \\
\mathbf{W} & & & & & & & & & \\
\mathbf{I} & & & & & & & & & \\
 & \mathbf{W}& & & \ddots & & & & & \\
  & \mathbf{I} & & & & & & & &  \\
  & & & & \ddots & & & & \mathbf{W} & \\
  & &  & & & & & & \mathbf{I} &  
\end{array}\right],
$$

Let $(\pi=\left[\pi_{11}, \pi_{21},\cdots,\pi_{m 1}, \cdots, \pi_{1 \omega}, \pi_{2 \omega}, \cdots, \pi_{m \omega}\right],\lambda)$ be optimal dual variables associated with the scenario constraints and row number constraint.

Then the dual problem is:

\begin{align}
    \min \quad & \sum_{\omega} D_{\omega} \mathbf{\pi}_{\omega} + N \lambda \\
    \text {s.t.} \quad & \sum_{\omega} \mathbf{T} \mathbf{\pi}_{\omega} + \mathbf{1} \lambda \geq (\mathbf{s}-1)\mathbf{T} \\
    & \mathbf{W} \mathbf{\pi}_{\omega} \geq -\mathbf{\bar{s}}~p_{\omega}, ~\omega \in \Omega \label{W_dual} \\ 
    & \mathbf{I} \mathbf{\pi}_{\omega} \geq \mathbf{0}, ~\omega \in \Omega \label{I_dual} 
\end{align}

$\mathbf{s}$ is the vector of group sizes, $s_i$. $\mathbf{\bar{s}}_{i} = s_i - s_{i-1}$ with $s_0 =1$.


From the constraints \eqref{W_dual} and \eqref{I_dual}, we have 

\begin{equation}
  \left\{
    \begin{array}{lr}
    0 \leq \pi_{\omega,m} \leq (s_m -s_{m-1})p_{\omega}, &  \\
    0 \leq \pi_{\omega, m-1} \leq (s_{m-1} -s_{m-2})p_{\omega}+ \pi_{\omega,m}, &  \\
    \qquad \vdots \qquad \vdots &  \\
    0 \leq \pi_{\omega,1} \leq (s_{1} - 1)p_{\omega}+ \pi_{\omega,2}, &
    \end{array}
  \right.
\end{equation}

Similarly, according to the complementary slackness,
when $y_{\omega,m}^{+} \neq 0$, $\pi_{\omega,m} = (s_m -s_{m-1})p_{\omega}$; when $y_{\omega,m}^{-} \neq 0$, $\pi_{\omega,m} = 0$. 

When both $y_{\omega,i}^{+}, y_{\omega,i}^{-}$ are equal to 0, to minimize the objective function, $\pi_{\omega,i}$ should also be 0.

Therefore, when we obtain $\mathbf{x},\mathbf{y}$ of the problem \eqref{linear_relaxation}, we can immediately obtain $\mathbf{\pi}$. And $\lambda$ can be obtained by the strong duality.

The pricing problem will be

\[\begin{split}\mbox{max}\quad & \sum_{i=1}^m \left[(s_i-1) -\sum_{\omega}\pi_{i \omega}\right] y_{i} - \lambda \\
  \mbox{s.t.} \quad & \sum_{i=1}^m s_i y_i \leq L  \\
  & y_i \geq 0, \mbox{integer}\quad \mbox{for}~ i=1,\ldots,m,\\
\end{split}\]

where $y_i$ indicate the number of times group type $i$ is placed in the new pattern.

By solving the pricing problem, we can obtain a new cutting pattern, then add it to $T$. Then solve the problem \eqref{BD_master2} to obtain $(x^{*}, z^{*})$ and continue the Benders Decomposition.

\subsubsection{Max regret}
Let $D$ be the polyhedron including all feasible demands with $N$ rows, i.e., 
$D = \{d = (d_1,d_2,\ldots, d_n): Tx = d,\sum_{k} x_k \leq N, x_k \geq 0, \mbox{integer} \}$.

We denote by $z^{s}(d)$ the value given by a demand $d \in D$ for scenario $s$. According to our assumption, the larger seats can be utilized by the smaller group. Then, we have
$z^{s}(d) = \sum_{i=1}^{m-1}(s_i -1)(Tx + y_{i+1}^{+}-y_{i}^{+}) + (s_m-1)(Tx- y_m^{+})$.

When $s_i = i+1$, $z^{s}(d) = \sum_{i=1}^{m} i Tx - \sum_{i=1}^{m} y_{i}^{+}$, $y_{m}^{+} = (d_{m} - d_{m}^{s})^{+}$, $y_{i}^{+} = (d_{i} - d_{i}^{s} + y_{i+1}^{+})^{+}, i = 1, \ldots, m-1$.

Let $z^{s}_{*}$ be the optimal solution value under scenario $s$, i.e., the solution value of the following problem.

\begin{align*}
  z^{s}_{*} = \mbox{max}\quad & \sum_{k=1}^K \sum_{i=1}^m (s_i-1) t_{i}^{k}x_{k} \\
  \mbox{s.t.} \quad & \sum_{k=1}^K x_{k} \leq N \\
  & \sum_{k=1}^K t_i^k x_k \leq d_i^{s},\quad i=1,\ldots,m \\
  & x_{k} \geq 0, \mbox{integer} \quad k = 1,\ldots,K
\end{align*}

The regret associated with demand $d$, for scenario $s$, is then $r^{s}(d) = z^{s}_{*} - z^{s}(d)$.

Let $S$ denote the set of all possible scenarios $s$, then $D \subset S$.

\begin{definition}
  We say $d^{s_0}$ associated with $s$ is the minimum demand if it satisfies $z^{s}_{*} = z^{s_0}_{*}$, $d^{s} \notin D$.
\end{definition}

Thus, $d^{s_0}_{i} \leq d^{s}_{i}$.

The min-max regret problem is to find a feasible demand $d$ such that the maximum regret is minimized.

\begin{align*}
  \mbox{min}_{d} \ \mbox{max}_{s \in S}\quad & r^{s}(d) \\
  \mbox{s.t.} \quad & \sum_{k=1}^K x_{k} \leq N \\
  & \sum_{k=1}^K t_i^k x_k \leq d_i,\quad i=1,\ldots,m \\
  & x_{k} \geq 0, \mbox{integer} \quad k = 1,\ldots,K
\end{align*}

$\mbox{min}_{d} \ \mbox{max}_{s \in S} \ r^{s}(d) = \mbox{min}_{d} \ \mbox{max}_{s \in S} [(\max_{d^{s} \in S_0} \sum i d^{s}) - \sum_{i=1}^{m} (i d_i - y_{i}^{+})]$

It is easy to find that the min-max regret is 0 when we take $d = d^{s} \in D$.

Thus, we only consider the maximum regret given a demand $d^{0}$.

Then the maximum regret is $\max_{s} \sum_{i}^{m} y_{i}^{+} + \sum_{i} i d^{s}_{i} - \sum_{i} i d^{0}_{i}, y_{m}^{+} = (d_{m}^{0} - d_{m}^{s})^{+}$, $y_{i}^{+} = (d_{i}^{0} - d_{i}^{s} + y_{i+1}^{+})^{+}, i = 1, \ldots, m-1$.

\begin{thm}
  The regret reaches its maximum if and only if $d^{s}$ is at the vertex of $D$.
\end{thm}

When $s \notin S_0$, the increase of any element of $d^{s_0}$ will keep the value of $\sum_{i} i d^{s}_{i}$ unchanged and the value of $\max_{s} \sum_{i} y_{i}^{+}$ non-increasing.

When $s \in S_0$, if $s$ is not at the vertex of $D$, then the increase of $d^{s}$ will make the value of $\sum_{i} i d^{s}_{i} + \max_{s} \sum_{i} y_{i}^{+}$ non-decreasing until $d^{s}$ reaches the vertex.

Therefore, the regret reaches its maximum if and only if $d$ is at the vertex of $D$.

Now, we consider to solve the following problem:

\begin{equation}\label{regret_problem}
\begin{aligned}
  \mbox{max}_{s} & \sum_{i} y_{i}^{+} + \sum_{i} i d^{s}_{i} - \sum_{i} i d^{0}_{i} \\
  \mbox{s.t.} \quad & d^{s} \in D = \{d = (d_1,d_2,\ldots, d_n): Tx = d,\sum_{k} x_k \leq N, x_k \geq 0, \mbox{integer} \} \\
  & y_{i}^{+} = (d_{i}^{0} - d_{i}^{s} + y_{i+1}^{+})^{+}, i = 1, \ldots, m-1 \\
  & y_{m}^{+} = (d_{m}^{0} - d_{m}^{s})^{+}.
\end{aligned}
\end{equation}

Notice that every $d^{s}$ can be expressed as $d^{s} = Tx$, then let $w_{m} = (d^{0} - Tx)_{m}^{+}$, $w_{i} = ((d^{0} - Tx)_{i}+ y_{i+1}^{+})^{+}, i =1 ,\ldots, m-1$.
 
Then the problem \eqref{regret_problem} can be reformulated as 

\begin{equation}\label{regret_problem_1}
  \begin{aligned}
    \mbox{max}_{x,w} & (\sum_{i} i (Tx)_{i} - \sum_{i} i d^{0}_{i} + \min \sum_{i} w_{i}) \\
    \mbox{s.t.} \quad & w_m \geq (d^{0}- Tx)_{m} \\
    & w_{i} \geq (d^{0}- Tx)_{m-1} + w_{i+1}, i =1, \ldots,m-1 \\
    & w_i \geq 0, i =1, \ldots,m \\
    & \sum_{k} x_{k} \leq N \\
    & x_k \geq 0, \mbox{integer}.
  \end{aligned}
\end{equation}
  
We can introduce a new variable $z$ to satisfy $z \leq z(x) =\{\min \sum_{i} w_{i}: w_{m} \geq (d^{0}- Tx)_{m}, w_{i} \geq (d^{0}- Tx)_{m-1} + w_{i+1}, i =1, \ldots,m-1, w_i \geq 0 \}$. Then, we can obtain the dual:
\[\{\max \alpha{'}(d^{0}- Tx): 0 \leq \alpha_{1} \leq 1, 0 \leq \alpha_{i} \leq \alpha_{i-1} + 1, i=2,\ldots,m \}\]

Let $\alpha_0 = 0$, an optimal solution to the dual is given by
\begin{align*}
  & \alpha_{i} =0, i =1,\ldots,m \ \text{if}~  d^{0}-Tx < 0,\\ 
  & \alpha_{i} = \alpha_{i-1}+1,  i =1,\ldots,m \ \text{if}~  d^{0}-Tx \geq 0
\end{align*}

The master problem will be:

\begin{equation}\label{regret_problem_2}
  \begin{aligned}
    \mbox{max}_{x,z} & \sum_{i} i (Tx)_{i} - \sum_{i} i d^{0}_{i} + z \\
    \mbox{s.t.} \quad & z \leq \alpha{'} (d^{0}- Tx) \\
    & \sum_{k} x_{k} \leq N \\
    & x_k \geq 0, \mbox{integer}.
  \end{aligned}
\end{equation}

Notice that this problem is just one scenario version of problem \eqref{BD_master2}, thus, we can use column-and-cut to solve it directly.

\begin{algorithm}[H]\label{column_and_cut_algo1}
  \caption{The column-and-cut algorithm}
    \begin{description}
    \item[Step 1.] Solve LP form of \eqref{regret_problem_2} with $\alpha^0 = \mathbf{0}$.
    Then, obtain the solution $(x_0, z^{0})$ and dual solution $(\pi, \lambda)$.
    \item[Step 2.] Set the upper bound $UB = c{'} x_0 +  z^{0} - \sum_{i} i d^{0}_{i}$
    \item[Step 3.]
    For $x_0$, we can obtain $\alpha^{1}$ and $z^{(0)}$, set the lower bound $LB = c{'} x_0 +  z^{(0)} - \sum_{i} i d^{0}_{i}$
    \item[Step 4.]
    If $(\alpha^{1}){'}(\mathbf{d}^{0}- \mathbf{T}x_0) < z^{(0)}$, add one new constraint, $(\alpha^{1}){'}(\mathbf{d}^{0}- \mathbf{T}x) \geq z$, to LP \eqref{regret_problem_2}.
    \item[Step 5.]
    Solve the pricing problem with $(\pi,\lambda)$, add a new cutting pattern and update $T$.
    \vspace{5pt}
    \item[Step 6.] Solve the updated LP \eqref{regret_problem_2}, obtain a new solution $(x_1, z^{1})$ and update UB.
    \item[Step 7.] Repeat step 3 until $UB - LB < \epsilon$.(Or in our case, UB converges.)
   \end{description}
  \end{algorithm}

\subsubsection{Two-stage Robust optimization}

We can find that the worst scenario is $d^{s}$ when all elements $d_i^{s}$ take their minimum values. 


\subsubsection{Details}
% \begin{equation}
  % \begin{aligned}
%     \max \quad & c{'} x + E(\max \{d -Tx , 0\}) \\
%     \text {s.t.} \quad & \sum_{k \in K} x_k = N \\
%      & x \geq 0
%   \end{aligned}
% \end{equation}

Sample Average Approximation(SAA): generate the scenarios.

How to deal with the continuous situation?

Multi-cut, Single-Cut

How to know the valid cuts:

If we can find several solutions from theorem \eqref{optimal_sol_sub_dual} and these solutions do not dominate each other, we can add them into the cuts pool together during one iteration.

Generate enough cutting patterns at the beginning or use the column generation.

Disaggregated, Aggregated form

Benders Decomposition: relaxed master problem $(x_k,z_\omega)$, subproblems: add cuts
% When we use the simplex method, the non-linear will be satisfied naturally.

\subsection{Occupancy by the greedy way}

Recall that for any pattern $k$, the occupancy is $\frac{S-l(k)}{S-1}$ and the largest occupancy is $O^{*}(S) = \frac{S-l(k)}{S-1}, k \in I_1$, where $l(k)$ is the loss for pattern $k$.

For $[2,3,4]$, $S = 4q + r$, the largest loss,$l^{*}$, is $q+ \sign(r)$.

If $S =20, q = 5, r=0$, $l^{*} = 5$, $O^{*}(S) = \frac{15}{20} \approx 80\%$

If we only use 2 to fill one row, $O(S) = \frac{10}{19}$.

If we have six seats, 3 groups with size of 2 or 2 groups with size of 3.

The occupancy will increse from $\frac{3}{6}, 50\%$ to $\frac{4}{6}, 66.7\%$. On average, one more people for six seats if we allow groups with size of 3 join.

If we have 12 seats, 4 groups with size of 3 or 3 groups with size of 4.

The occupancy will increse from $\frac{8}{12}, 66.7\%$ to $\frac{9}{12}, 75\%$. On average, one more people for 12 seats if we allow groups with size of 4 join.

Suppose the demand, $d_2,d_3,d_4$ has a close ratio, for example, one to one to one, then according to the greedy way, we have $m_1 = \lceil \frac{d_4}{q} \rceil$ rows with the largest pattern at first. The corresponding occupancy is $\frac{S- q- \sign(r)}{S-1}$.

The left demand, $d^{'}_4$ is $d_4 - m_1 q$, taking $4(d_4 - m_1 q)$ seats and having the occupancy of $\frac{3}{4}$.

The number of left seats is $S_1 = S- 4(d_4 - m_1 q)$. For $S_1$, $S_1 = 3q_1 + r_1$, the largest occupancy is $\frac{S_1 - q_1 -\sign(r_1)}{S_1-1}$.

The left demand for group with size of 3 is $d^{'}_3= d_3 - q_1$. Continue...

\subsubsection{Dynamic Programming}
Besides, DP may be a possible method.

We can use DP to solve this problem for the fixed supply if we know the arrival rates.

To ensure optimality, we need to follow some rules:

1. When there are enough supplies, we will accept them directly.

2. The demand can be accepted by a larger-size supply when there is not enough corresponding-size supply. 

3. The demand can only be satisfied by one larger-size supply.

Basic Bellman equation for network capacity: $V_{t}(\X) = E[\max_{\mathbf{u}}\{R_{t}\mathbf{u}+ V_{t+1}(\X- A\mathbf{u})\}]$

$\X$ is the remaining capacity for each group type.

Boundary condition: $V_{t}(\X=0) =0, V_{T+1}(\X) =0$.
 
Let $e_{i} = [\underbrace{0, \ldots, 0}_{i-1},1,0, \ldots, 0]$.

When $\X > 0$(all elements is above 0), $\mathbf{u} = e_i, i \in I$. The value function $V_{t}(\X) = E[\max\{\mathbf{u} \mathbf{s} -1 + V_{t+1}(\X- \mathbf{u})\}]$.

When some element of $\X$ is 0, say $x_{i}$, then here comes a group $i$, if we accept it by supply $j$, $\mathbf{u} = [-1, \underbrace{0,\ldots,0}_{i}, 1,0,\ldots,0], [0, -1, \underbrace{0,\ldots,0}_{i}, 1,0,\ldots,0], \cdots$. Here, $\mathbf{u}$ indicates all the decisions, i.e, group type $i$ is served by supply $j$, $i<j$. Then the value function $V_{t}(\X) = E[\max\{\mathbf{u} \mathbf{s} -1 + V_{t+1}(\X- \mathbf{u})\}]$, $\mathbf{u} \mathbf{s}  = s_i$.

Example: $[0,6,8] \to [1,6,7]$ when $1$ is served by $3$.

\begin{algorithm}[H]\label{DP_based}
  \caption{Backward method to make decisions under fixed supply}
  \begin{description}
    \item[Step 1.] Obtain a supply, $\X^{0} = [x_1,\ldots,x_{J}]$, from the stochastic programming.
    \item[Step 2.] For the arrival group type $i$, if $x_{i} > 0$, accept it. $V_{t}(\X) = s_{i}-1 + V_{t+1}(\X- e_i)$. If $x_{i} = 0$, $V_{t}(\X) = E[\max_{\mathbf{u}}\{\mathbf{u} \mathbf{s} -1 + V_{t+1}(\X- \mathbf{u})\}]$.
    % \item[Step 3.] If $x_1 =0$, go to step 4. If $x_1 =1$, find if there exists $x_i >0, i \neq 1$, if so, make $x_0$ to 0, if not, continue to accept next arrival group, then make $x_0$ to 0.
    \item[Step 3.] Set the boundary conditions: $V_{t}(\X= \mathbf{0}) =0, V_{T+1}(\X) =0$.
    \item[Step 4.] Calculate $V_{1}(\X^{0})$.
  \end{description}
\end{algorithm}

Complexity: $O(T \cdot |x_1| \cdot |x_2| \cdot \ldots \cdot |x_{J}|)$.

According to the rule 1, we only need to obtain $V_{1}(0, x_{2}, \cdots, x_{J})$, $V_{1}(x_{1}, 0, \cdots, x_{J}),\ldots, V_{1}(x_{1}, \cdots, x_{J-2},0, x_{J})$.

Use the same example to illustrate:

$V_{1}([3,3]) = p_{2} (1+ V_{2}([2,3])) + p_{3} (2 + V_{2}([3,2]))$

$V_{1}([3,3]) = 3 + V_{4}([0,3])$ when the first three arrivals are groups with $2$.

$V_{4}([0,3]) = p_{2} \max\{1 + V_{5}(0,2), V_{5}(0,3)\} + p_{3} (2+ V_{5}(0,2))$

$\cdots \cdots$

$V_{9}([0,2]) = p_{2} \cdot (1 + V_{10}(0,1)) + p_{3} \cdot (2+ V_{10}(0,1))$

$V_{9}([2,0]) = p_{2} \cdot (1 + V_{10}(1,0))$

$V_{10}([0,1]) = p_{2} \cdot 1 + p_{3} \cdot 2$

$V_{10}([1,0]) = p_{2} \cdot 1$

Notice that not all possible demands, $d \in D$, can be developed from $\X^{0}$. Thus, the stochatic information is still useful.