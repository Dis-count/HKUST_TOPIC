\section{Dynamic Primal Based on Patterns}

Let $y_{j \bm{h}}$ denote the proportion of pattern $\bm{h}$ used in knapsack $j$. The primal problem can be formulated as:

\begin{equation}\label{improve_primal}
    \begin{aligned}
    \max \quad & \sum_{i=1}^M \sum_{j=1}^N r_i x_{i j} \\
    \text {s.t.} \quad & \sum_{j=1}^N x_{i j} \leq d_i, \quad i \in \mathcal{M}, \\
    & x_{i j} \leq \sum_{\bm{h} \in S(c_{j})} h_i y_{j \bm{h}}, \quad i \in \mathcal{M}, j \in \mathcal{N}, \\
    & \sum_{\bm{h} \in S(c_{j})} y_{j \bm{h}} \leq 1, \quad j \in \mathcal{N}.
    \end{aligned}
\end{equation}

The first set of constraints demonstrate that for each item type $i$, the sum of assigned items and unassigned items equals the total demand. The second set of constraints shows that the number of items of type $i$ assigned in knapsack $j$ is not larger than the sum of $h_{i}$ (the count of type $i$ items in pattern $\bm{h}$) weighted by the pattern proportions $y_{i \bm{h}}$. The total proportion of patterns uesd in knapsack $j$ cannot exceed 1.

\begin{prop}\label{primal}
If the optimal solution $x_{ij}^{*}$ to \eqref{improve_primal} satisfies $x_{ij}^{*} > 0$ for a pair $(i,j)$, then for that knapsack $j$, we have $$\bm{h}^{*} \in \arg\max_{\bm{h} \in S(c_j)} \sum_{i} \beta_{ij}^{\dag} h_{i}, h_{i}^{*} \geq 1.$$
\end{prop}

In contrast to Lemma \ref{BPP}, this lemma ensures the existance of a knapsack $j$ to accommodate item type $i$ when $x_{ij}^{*} > 0$. This eliminates the need for explicit existance verification.

% Then, the following hierarchy holds: $V(\text{DLP}) = V(\text{BPC}) \geq V(\text{I-BPC}) \geq V^{\text{DP}}$.

% Any feasible solution to \eqref{improve_primal} yields a feasible solution to linear relaxation of SPDR having the same objective value, then we have  $V(\text{BPC}) \geq V^{\text{HO}} \geq V^{\text{DP}}$.



\subsection{Solve the Dynamic Primal}
% A pattern $\bm{h}$ is said to be inefficient if a mixture of other patterns can be used to generate more revenue for the same (or lower) consumption rate.

The pattern $\bm{h}$ is efficient for knapsack $j$ if and only if, for some $(\alpha_{1}, \ldots, \alpha_{M}, \gamma_{j})$ (except that $\alpha_{i} = r_i, \forall i$), $\bm{h}$ is the optimal solution to $$\max_{\bm{h}} \sum_{i=1}^{M} (r_i - \alpha_{i}) h_{i} - \gamma_{j}$$

To generate all efficient patterns, we need to solve the subproblem for each knapsack $j$:

\begin{align}\label{subproblem}
    \max \quad & \sum_{i=1}^{M} (r_i - \alpha_{i}) h_{i} - \gamma_{j} \\
    \text {s.t.} \quad & \sum_{i= 1}^{M} w_{i} h_{i} \leq c_j, \notag \\
    & h_{i} \in \mathbb{N}, \quad i \in \mathcal{M}. \notag
\end{align} 

If the optimal value of \eqref{subproblem} is larger than $0$, the primal $\eqref{improve_primal}$ reaches the optimal. Otherwise, a new pattern can be generated.

One important fact is that only efficient sets are used in the solution to \eqref{improve_primal}. Therefore, if $y_{j \bm{h}}^{*} > 0$ is the optimal solution to \eqref{improve_primal}, then $\bm{h}$ is an efficient pattern.


A pattern $\bm{h}$ is dominant if there is no distinct pattern $\bm{h}{'}$ where every component of $\bm{h}{'}$ is greater than or equal to the corresponding component of $\bm{h}$. The efficient pattern is a dominating pattern. (If $\alpha_{i} = r_i$, \eqref{improve_primal} reaches the optimal and no pattern will be generated.)

The relation between the capacity and the demand shows the different structure of the optimal solution.

\begin{lem}
When $\sum_{i=1}^{M} d_{i} w_{i} < \sum_{j=1}^{N} c_{j}$, we have $\gamma_{j}^{*} =0, \forall j$, $\beta_{ij}^{\dag *} =0, \forall i,j$ and $\alpha^{*}_{i} = r_i, \forall i$. There exists at least one knapsack $j$ such that $\sum_{\bm{h} \in S(c_{j})} y_{j \bm{h}}^{*} < 1$.

When $\sum_{i=1}^{M} d_{i} w_{i} \geq \sum_{j=1}^{N} c_{j}$, we have $\sum_{\bm{h} \in S(c_{j})} y_{j \bm{h}}^{*} = 1, \forall j$.
\end{lem}


\begin{algorithm}[H]
    \caption{Dynamic Primal}\label{algo_improve_primal}
    \For{$t = 1, \ldots, T$}{
      {Observe a request of type $i$\;}
      \If{$c_{j}^{t} = w_i, \exists j$}
      {Assign the item to knapsack $j$\; 
      \Continue}
      {Solve problem \eqref{improve_primal} with $\bm{d}^{[t, T]}$ \;
      Obtain an optimal solution $x_{ij}$ \;}
      \eIf{$\max_{j}\{x_{ij}\} > 0$}
      {Set $k = \arg \max_{j}\{x_{ij}\}$ and break ties\;
      Assign the item to knapsack $k$, let $c_{k}^{t+1} \gets c_{k}^{t} - w_{i}$\;}
      {Reject the request\;}}
\end{algorithm}

Meanwhile, it guarantees feasible placement. Once a request is accepted, the policy ensures it can be assigned to a suitable knapsack without additional feasibility checks.

\begin{example}
For the dynamic primal, the optiaml solution is given by $\bm{x}_{1}^{*} = [1, 1, 0, 0]$, $\bm{x}_{2}^{*} = [1, 0, 2, 1]$, $\bm{x}_{3}^{*} = [0, 1, 0, 0]$. This indicates that type 1 can be assigned to knapsacks 1 or 2, type 2 cannot be assigned to knapsack 2, type 3 can only be assigned to knapsack 2. 

In the optimal solution, the efficient patterns for each knapsack are $[1, 1, 0]$, $[1, 0, 1]$, $[0, 2, 0]$, $[0, 1, 0]$. For instance, $[1, 1, 0]$ shows that knapsack 1 can hold one item of type 1 and one of type 2.

Using the decision variable $x_{ij}$ to represent these assignments is a straightforward and easily implementable approach.
\end{example}


% \begin{example}
% Consider $M =3$, $N =4$, $w_{1} = 3, w_{2} = 4, w_{3} = 5$, $r_{1} = 4, r_{2} = 6, r_{3} = 8$, $\bm{C} = [7, 8, 8, 4]$, $T = 8$, stationary arrival probability, $\lambda_{1} = \lambda_{3} = \frac{1}{4}$, $\lambda_{2} = \frac{1}{2}$. Then the expected demand for each type is $\bm{d} = (2, 4, 2)$.

% For the traditional bid-price control, for each $j$, $\beta_{j}^{*} = \frac{4}{3}$. $z(BPC) = \frac{124}{3}$. Two drawbacks: there is no difference among knapsacks. Even $r_{3} - \beta_{4}^{*} * w_{3} > 0$, it is infeasible for type 3 assigned in knapsack 4.

% For the BPP, $\bm{\beta}_{1}^{*} = [4, 4, 4, 6]$, $\bm{\beta}_{2}^{*} = [6, 6, 6, 6]$, $\bm{\beta}_{3}^{*} = [10, 8, 8, 8]$. $z(BPP) = 40$. $\alpha = [0, 0, 0]$, $\gamma = [10, 12, 12, 6]$.

% $r_{1} - \bm{\beta}_{1}^{*} = [0, 0, 0, -2]$, $r_{2} - \bm{\beta}_{2}^{*} = [0, 0, 0, 0]$, $r_{3} - \bm{\beta}_{3}^{*} = [-2, 0, 0, 0]$.

% Drawback: need to check whether $j$ exists for $\bm{h}^{*} \in \arg\max_{\bm{h} \in S(c_{j_0})} \sum_{i} \beta_{ij_0}^{\dag *} h_{i}, h_{i}^{*} \geq 1$.

% For example, $r_{3} - \bm{\beta}_{3}^{*} = [-2, 0, 0, 0]$ indicates type 3 cannot be assigned in knapsack 1. While the generated patterns for knapsack 4 are $[0, 1, 0], [1, 0, 0]$, which do not contain $h_{3}$, type 3 can only be assigned to knapsack 2 or 3.

% % $[1, 1, 0], [2, 0, 0], [0, 0, 1]$, $[0, 2, 0], [1, 0, 1]$, $[0, 2, 0], [1, 0, 1]$, $[0, 1, 0], [1, 0, 0]$

% For the primal, $\bm{x}_{1}^{*} = [1, 1, 0, 0]$, $\bm{x}_{2}^{*} = [1, 0, 2, 1]$, $\bm{x}_{3}^{*} = [0, 1, 0, 0]$. It indicates that type 1 can be assigned in knapsacks 1 or 2, type 2 cannot be assigned in knapsack 2, type 3 can only be assigned in knapsack 2. 

% It may contain multiple efficient patterns for one knapsack. In this example, there is exactly one efficient pattern for each knapsack: $[1, 1, 0]$, $[1, 0, 1]$, $[0, 2, 0]$, $[0, 1, 0]$. It shows that knapsack 1 can assign type 1 and 2, so on and so forth.

% Using $x_{ij}$ to make the decision is straightforward and easy to implement.
% \end{example}


% \subsection{Type Analyses}

% When there is only one type, the optimal policy is straightforward, i.e., accept the request until the capacity is insufficient. 

% When there are two types, 

% When will the threshold policy be the optimal?

\subsection{Extension}\label{Extension}
Sometimes, we do not need to generate all feasible patterns. The generated patterns may need to satisfy certain restrictions, such as certain items not being allowed in certain knapsacks, or relationships between items. 

For example, we can add constraints like:
$h_{i} = 0$ (Item $i$ is excluded), $h_i + h_k \leq 1$ (Items $i$ and $k$ are mutually exclusive). $h_i \leq \text{max count}_{i}$ (An upper bound on the number of item $i$).

To represent these scenarios in a general form, we consider the following extended subproblem for knapsack $j$:

$$
\begin{aligned}
\max & \sum_{i=1}^M\left(r_i-\alpha_i\right) h_i-\gamma_j \\
\text {s.t.} & \sum_{i=1}^M w_i h_i \leq c_j \\
& \mathbf{A}_j \mathbf{h} \leq \mathbf{b}_j \\
& \mathbf{h} \in \mathbb{N}^M \\
& h_i=0, \quad \forall i \notin \mathcal{F}_j
\end{aligned}
$$

Here, the second constraint $\mathbf{A}_j \mathbf{h} \leq \mathbf{b}_j$ encompasses various linear restrictions on the pattern, such as mutual exclusion, dependency, and quantity limits. The set $\mathcal{F}_j$ contains the items permitted for knapsack $j$.